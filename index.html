<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel | Bagus Ardianto</title>
  <meta name="robots" content="noindex, nofollow">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: 'JetBrains Mono', monospace; background: #000; color: #fff; }
    .glass-pixel {
      background: rgba(20, 20, 30, 0.6);
      backdrop-filter: blur(12px);
      border: 2px solid rgba(255,255,255,0.1);
      box-shadow: 0 8px 20px rgba(0,0,0,0.5), 4px 4px 0 0 currentColor;
    }
    .admin-scroll::-webkit-scrollbar { width: 4px; }
    .admin-scroll::-webkit-scrollbar-track { background: transparent; }
    .admin-scroll::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }
    .fade-in { animation: fadeIn 0.2s ease-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body class="antialiased">
  <div id="app" class="min-h-screen flex flex-col">
    <!-- Bagian ini akan diisi oleh JS -->
    <div id="login-view" class="hidden flex-1 items-center justify-center p-6"></div>
    <div id="admin-view" class="hidden flex-1 flex flex-col"></div>
  </div>

  <script>
    // ==================== KONFIGURASI ====================
    const SUPABASE_URL = 'https://dkftqhkpwymbdtpznwto.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_Hlzx5XRu6hxnoxOCNKk7vg_9829kGve';
    const PUBLIC_URL = 'https://start.progresix.site';

    // ==================== SUPABASE CLIENT ====================
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ==================== IKON GLOBAL ====================
    const Icons = {
      instagram: () => `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"/></svg>`,
      github: () => `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/></svg>`,
      x: () => `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4l11.733 16h4.267l-11.733-16zM4 20l6.768-6.768M20 4l-6.768 6.768"/></svg>`,
      youtube: () => `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.42a2.78 2.78 0 0 0-1.94 2C1 8.11 1 12 1 12s0 3.89.46 5.58a2.78 2.78 0 0 0 1.94 2c1.72.42 8.6.42 8.6.42s6.88 0 8.6-.42a2.78 2.78 0 0 0 1.94-2C23 15.89 23 12 23 12s0-3.89-.46-5.58z"/><polygon points="9.75 15.02 15.5 12 9.75 8.98 9.75 15.02"/></svg>`,
      tiktok: () => `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 12a4 4 0 1 0 4 4V4a5 5 0 0 0 5 5"/></svg>`,
      linkedin: () => `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg>`,
      donate: () => `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4"/><path d="M4 6v12c0 1.1.9 2 2 2h14v-4"/><path d="M18 12a2 2 0 0 0-2 2c0 1.1.9 2 2 2h4v-4h-4z"/></svg>`,
      trash: () => `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>`,
      upload: () => `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>`,
      global: () => `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>`,
      check: () => `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>`,
      share: () => `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>`,
      copy: () => `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>`,
      whatsapp: () => `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 1 1-7.6-14h.8c4.3 0 7.7 3.5 7.7 7.7v2.5z"/></svg>`,
    };

    function getIconByUrl(url) {
      const l = url.toLowerCase();
      if (l.includes('instagram.com')) return Icons.instagram();
      if (l.includes('github.com')) return Icons.github();
      if (l.includes('twitter.com') || l.includes('x.com')) return Icons.x();
      if (l.includes('youtube.com') || l.includes('youtu.be')) return Icons.youtube();
      if (l.includes('tiktok.com')) return Icons.tiktok();
      if (l.includes('linkedin.com')) return Icons.linkedin();
      return Icons.global();
    }

    // Kompres gambar
    async function compressImage(file, maxWidth = 1200) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
          const img = new Image();
          img.src = e.target.result;
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            if (width > maxWidth) {
              height = (maxWidth / width) * height;
              width = maxWidth;
            }
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            canvas.toBlob((blob) => resolve(blob), 'image/webp', 0.8);
          };
        };
      });
    }

    // ==================== STATE ====================
    let session = null;
    let profile = { id: null, name: '', bio: '', avatar_url: '', bg_url: '', text_color: '#ffffff' };
    let links = [];
    let saveStatus = null;

    const loginView = document.getElementById('login-view');
    const adminView = document.getElementById('admin-view');

    // ==================== RENDER FUNCTIONS ====================
    function renderLogin() {
      loginView.classList.remove('hidden');
      loginView.classList.add('flex');
      adminView.classList.add('hidden');
      adminView.classList.remove('flex');

      loginView.innerHTML = `
        <form id="login-form" class="w-full max-w-xs glass-pixel p-10 bg-zinc-900/80 space-y-6 text-white fade-in border-2 border-white/20">
          <h2 class="text-xl font-black uppercase italic border-b-2 border-white pb-3 tracking-tighter">Admin Auth</h2>
          <input name="email" type="email" placeholder="EMAIL" class="w-full bg-black/50 border-2 border-zinc-700 p-4 text-xs outline-none focus:border-white" required />
          <input name="password" type="password" placeholder="PASSWORD" class="w-full bg-black/50 border-2 border-zinc-700 p-4 text-xs outline-none focus:border-white" required />
          <button class="w-full py-4 bg-white text-black font-black uppercase text-xs hover:bg-zinc-200 transition">LOG_IN</button>
        </form>
      `;

      document.getElementById('login-form').addEventListener('submit', handleLogin);
    }

    function renderAdmin() {
      loginView.classList.add('hidden');
      loginView.classList.remove('flex');
      adminView.classList.remove('hidden');
      adminView.classList.add('flex');

      adminView.innerHTML = `
        <div class="sticky top-0 z-40 bg-black/90 backdrop-blur-xl border-b-4 border-white p-6 flex justify-between items-center">
          <h1 class="text-xl font-black uppercase italic tracking-tighter">ADMIN</h1>
          <div class="flex gap-3">
            <a href="${PUBLIC_URL}" target="_blank" class="px-4 py-2 border-2 border-white font-black text-[9px] uppercase hover:bg-white hover:text-black transition">Preview</a>
            <button id="logout-btn" class="px-4 py-2 bg-red-600 font-black text-[9px] uppercase hover:bg-red-500 transition">Logout</button>
          </div>
        </div>

        <div class="flex-1 overflow-y-auto admin-scroll p-6 md:p-12 pb-44">
          <div class="max-w-5xl mx-auto grid md:grid-cols-2 gap-10">
            <!-- Kolom kiri: assets & profile -->
            <div class="space-y-8">
              <section class="p-6 glass-pixel bg-zinc-900/40 border-2 border-zinc-800">
                <h3 class="text-[10px] font-black uppercase tracking-widest text-zinc-400 mb-6 border-l-4 border-indigo-500 pl-3">ASSETS</h3>
                <div class="grid grid-cols-2 gap-4">
                  <div class="space-y-3">
                    <div id="avatar-preview" class="aspect-square border-2 border-zinc-800 bg-black overflow-hidden relative">
                      ${profile.avatar_url ? `<img src="${profile.avatar_url}" class="w-full h-full object-cover" />` : ''}
                      <div id="avatar-uploading" class="absolute inset-0 bg-black/80 flex items-center justify-center hidden"><div class="loading-spin w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div></div>
                    </div>
                    <label class="flex items-center justify-center gap-2 w-full py-2 bg-white text-black font-black text-[8px] cursor-pointer">
                      ${Icons.upload()} AVATAR
                      <input type="file" id="avatar-file" class="hidden" accept="image/*" />
                    </label>
                  </div>
                  <div class="space-y-3">
                    <div id="bg-preview" class="aspect-square border-2 border-zinc-800 bg-black overflow-hidden relative">
                      ${profile.bg_url ? `<img src="${profile.bg_url}" class="w-full h-full object-cover" />` : ''}
                      <div id="bg-uploading" class="absolute inset-0 bg-black/80 flex items-center justify-center hidden"><div class="loading-spin w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div></div>
                    </div>
                    <label class="flex items-center justify-center gap-2 w-full py-2 bg-zinc-800 text-white font-black text-[8px] cursor-pointer">
                      ${Icons.upload()} BACKGROUND
                      <input type="file" id="bg-file" class="hidden" accept="image/*" />
                    </label>
                  </div>
                </div>
              </section>

              <section class="p-6 glass-pixel bg-zinc-900/40 border-2 border-zinc-800 space-y-5">
                <h3 class="text-[10px] font-black uppercase tracking-widest text-zinc-400 border-l-4 border-indigo-500 pl-3">PROFILE_INFO</h3>
                <div class="flex items-center gap-4 bg-black/50 p-3 border border-zinc-800">
                  <input type="color" id="text-color" value="${profile.text_color}" class="w-8 h-8 bg-transparent cursor-pointer" />
                  <span class="text-[9px] font-bold uppercase">Accent Color</span>
                </div>
                <input type="text" id="profile-name" value="${profile.name}" placeholder="FULL NAME" class="w-full bg-black/50 border border-zinc-800 p-3 text-xs font-bold outline-none focus:border-white" />
                <textarea id="profile-bio" placeholder="BIO" class="w-full bg-black/50 border border-zinc-800 p-3 text-xs h-20 outline-none focus:border-white">${profile.bio}</textarea>
              </section>
            </div>

            <!-- Kolom kanan: links -->
            <div class="space-y-6">
              <div class="flex justify-between items-center border-l-4 border-indigo-500 pl-3">
                <h3 class="text-[10px] font-black uppercase tracking-widest text-zinc-400">LINKS_DATABASE</h3>
                <button id="add-link" class="bg-white text-black px-4 py-2 font-black text-[8px] hover:bg-zinc-200">+ ADD_NEW</button>
              </div>
              <div id="links-list" class="space-y-3"></div>
            </div>
          </div>
        </div>

        <!-- Tombol save global -->
        <div class="fixed bottom-0 left-0 right-0 p-6 z-50 flex justify-center pointer-events-none">
          <button id="save-profile" class="w-full max-w-sm pointer-events-auto bg-indigo-600 text-white p-5 flex items-center justify-center gap-4 font-black text-xs uppercase glass-pixel border-indigo-400 shadow-2xl hover:bg-indigo-500 transition-all">
            ${saveStatus === 'success' ? 'DATA_SYNC_OK' : saveStatus === 'saving' ? 'UPLOADING...' : 'SAVE_GLOBAL_CONFIG'}
          </button>
        </div>
      `;

      renderLinksList();
      attachAdminEvents();
    }

    function renderLinksList() {
      const container = document.getElementById('links-list');
      if (!container) return;
      container.innerHTML = links.map(link => `
        <div class="p-4 border-2 border-zinc-800 bg-zinc-900/20 relative glass-pixel" data-id="${link.id}">
          <button class="delete-link absolute top-3 right-3 text-zinc-600 hover:text-red-500">${Icons.trash()}</button>
          <select class="link-type bg-black text-[8px] font-black p-1 border border-zinc-800 mb-3 outline-none">
            <option value="square" ${link.type === 'square' ? 'selected' : ''}>CARD</option>
            <option value="social" ${link.type === 'social' ? 'selected' : ''}>SOCIAL</option>
          </select>
          <input class="link-title bg-transparent text-xs font-black block w-full border-b border-zinc-800 mb-2 py-1 uppercase outline-none" value="${link.title || ''}" placeholder="TITLE" />
          <input class="link-url bg-transparent text-[9px] text-zinc-500 block w-full outline-none" value="${link.url || ''}" placeholder="https://..." />
        </div>
      `).join('');

      // Attach events for each link
      document.querySelectorAll('.delete-link').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = e.target.closest('[data-id]').dataset.id;
          handleDeleteLink(id);
        });
      });

      document.querySelectorAll('.link-type').forEach(select => {
        select.addEventListener('change', (e) => {
          const id = e.target.closest('[data-id]').dataset.id;
          const link = links.find(l => l.id === id);
          if (link) link.type = e.target.value;
        });
      });

      document.querySelectorAll('.link-title').forEach(input => {
        input.addEventListener('input', (e) => {
          const id = e.target.closest('[data-id]').dataset.id;
          const link = links.find(l => l.id === id);
          if (link) link.title = e.target.value;
        });
      });

      document.querySelectorAll('.link-url').forEach(input => {
        input.addEventListener('input', (e) => {
          const id = e.target.closest('[data-id]').dataset.id;
          const link = links.find(l => l.id === id);
          if (link) link.url = e.target.value;
        });
      });
    }

    function attachAdminEvents() {
      document.getElementById('avatar-file').addEventListener('change', (e) => handleFileUpload(e, 'avatar'));
      document.getElementById('bg-file').addEventListener('change', (e) => handleFileUpload(e, 'bg'));
      document.getElementById('text-color').addEventListener('input', (e) => { profile.text_color = e.target.value; });
      document.getElementById('profile-name').addEventListener('input', (e) => { profile.name = e.target.value; });
      document.getElementById('profile-bio').addEventListener('input', (e) => { profile.bio = e.target.value; });
      document.getElementById('add-link').addEventListener('click', handleAddLink);
      document.getElementById('logout-btn').addEventListener('click', handleLogout);
      document.getElementById('save-profile').addEventListener('click', handleSave);
    }

    // ==================== HANDLERS ====================
    async function handleFileUpload(e, type) {
      const file = e.target.files[0];
      if (!file || !session?.user) return;

      const uploadingEl = type === 'avatar' ? document.getElementById('avatar-uploading') : document.getElementById('bg-uploading');
      uploadingEl.classList.remove('hidden');

      try {
        const compressedBlob = await compressImage(file, type === 'avatar' ? 400 : 1280);
        const fileName = `${session.user.id}/${type}_${Date.now()}.webp`;
        const { error: uploadError } = await supabaseClient.storage.from('avatars').upload(fileName, compressedBlob);
        if (uploadError) throw uploadError;
        const { data: { publicUrl } } = supabaseClient.storage.from('avatars').getPublicUrl(fileName);
        
        if (type === 'avatar') {
          profile.avatar_url = publicUrl;
          document.querySelector('#avatar-preview img')?.remove();
          document.querySelector('#avatar-preview').innerHTML += `<img src="${publicUrl}" class="w-full h-full object-cover" />`;
        } else {
          profile.bg_url = publicUrl;
          document.querySelector('#bg-preview img')?.remove();
          document.querySelector('#bg-preview').innerHTML += `<img src="${publicUrl}" class="w-full h-full object-cover" />`;
        }
      } catch (err) {
        console.error(err);
        alert('Upload gagal: ' + err.message);
      } finally {
        uploadingEl.classList.add('hidden');
      }
    }

    async function handleAddLink() {
      if (!session?.user) return;
      const { data, error } = await supabaseClient
        .from('links')
        .insert({ user_id: session.user.id, title: 'NEW_LINK', url: 'https://', type: 'square' })
        .select()
        .single();
      if (!error && data) {
        links.unshift(data);
        renderLinksList();
      } else {
        alert('Gagal menambah link');
      }
    }

    async function handleDeleteLink(id) {
      if (!confirm('Hapus link ini?')) return;
      const { error } = await supabaseClient.from('links').delete().eq('id', id);
      if (!error) {
        links = links.filter(l => l.id !== id);
        renderLinksList();
      } else {
        alert('Gagal menghapus');
      }
    }

    async function handleLogin(e) {
      e.preventDefault();
      const email = e.target.email.value;
      const password = e.target.password.value;
      const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if (error) {
        alert(error.message);
      } else {
        session = data.session;
        await fetchProfileAndLinks();
        renderAdmin();
      }
    }

    async function handleLogout() {
      await supabaseClient.auth.signOut();
      session = null;
      renderLogin();
    }

    async function handleSave() {
      if (!session?.user) return;
      setSaveStatus('saving');

      const { error: profErr } = await supabaseClient
        .from('profiles')
        .upsert({ id: session.user.id, ...profile });

      if (profErr) {
        alert('Gagal simpan profile: ' + profErr.message);
        setSaveStatus(null);
        return;
      }

      for (const link of links) {
        await supabaseClient
          .from('links')
          .update({ title: link.title, url: link.url, type: link.type })
          .eq('id', link.id);
      }

      setSaveStatus('success');
      setTimeout(() => setSaveStatus(null), 3000);
    }

    function setSaveStatus(status) {
      saveStatus = status;
      const btn = document.getElementById('save-profile');
      if (btn) {
        btn.innerHTML = status === 'success' ? 'DATA_SYNC_OK' : status === 'saving' ? 'UPLOADING...' : 'SAVE_GLOBAL_CONFIG';
      }
    }

    async function fetchProfileAndLinks() {
      if (!session?.user) return;
      const { data: prof, error: profErr } = await supabaseClient
        .from('profiles')
        .select('*')
        .eq('id', session.user.id)
        .maybeSingle();

      if (profErr) console.error(profErr);
      if (prof) {
        profile = prof;
      } else {
        profile = {
          id: session.user.id,
          name: 'Bagus Ardianto Adi Saputro',
          bio: 'Professional Profile',
          avatar_url: '',
          bg_url: '',
          text_color: '#ffffff'
        };
      }

      const { data: lnks, error: linksErr } = await supabaseClient
        .from('links')
        .select('*')
        .eq('user_id', session.user.id)
        .order('created_at', { ascending: false });

      if (!linksErr) links = lnks || [];
    }

    // ==================== INIT ====================
    (async () => {
      const { data: { session: currentSession } } = await supabaseClient.auth.getSession();
      session = currentSession;
      if (session) {
        await fetchProfileAndLinks();
        renderAdmin();
      } else {
        renderLogin();
      }
    })();
  </script>
</body>
</html>